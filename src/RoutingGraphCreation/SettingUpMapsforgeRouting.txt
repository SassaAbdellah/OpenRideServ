
   Setting Up Mapsforge Routing
   ============================ 


   This document is in the SVN for convenience only. 
   The most actual version is in the Wiki at
   http://openride.xeneris.net/trac/wiki/SettingUpMapsforgeRouting. 



   This is about setting up the mapsforge and especially the
   mapsforge-routing subproject. This is now used to build the routing
   files (routingGraph.hh) files, used by openride.

   While in the original [27]OpenRide Project, there was the
   [28]OpenRideRouting? subproject, in jORidewe let go of this, in favour
   of creating the hh-file directly inside a mapsforge installation. This
   however needs some patches to be applied to mapsforge, to be described
   in this document.

   While making mapsforge and mapsforge routing work, I blogged every
   step. This document may turn out to be useful when new problems arise
   in the process. The blog is here: [[29]BlogMakingMapsforgeWork]

Overview

    1.      Setting Up Mapsforge Routing
    1.1.    Overview
    

    2       Obtaining and Building Mapsforge

    2.1.    Building the Mapsforge Project

    2.2.    Building the Mapsforge-Routing subproject

    2.3.    Installing Osmosis and mapsforge plugins

    2.4.    Install the mapsforge-routing-hh plugin

    2.5.    Create and populate the OSM database

    2.6.    Creating the HH Graph
    2.6.1.  Obtaining the PBF Files
    2.6.2.  TODOS

===  2 Obtaining and Building Mapsforge ===

   A readonly version of mapsforge is provided for non developers. check
   out mapsforge readonly from subversion:
   svn checkout http://mapsforge.googlecode.com/svn/trunk/ mapsforge-read-only

==  2.1 Building the Mapsforge Project ==

   In general, the mapsforge project is build using maven (should work
   with both maven2 and maven3). In short, issue the command

   mvn clean install

   in the top directory of the mapsforge project. A more in depth
   discussion of building mapsforge is to be found here:

    http://code.google.com/p/mapsforge/wiki/GettingStartedDevelopers

=== 2.2 Building the Mapsforge-Routing subproject ==

   While maven seems to build all other subprojects of the mapsforge
   project, a pom.xml seems to be missing for the mapsforge-routing
   subproject.

   The mapsforge-routing subproject comes with a build-xml which
   unfortunately is missing the compile/build step, and does not work.

   Thus, we build the mapsforge-routing subproject using a patched
   build.xml called "build-joride.xml" attached to this document.

   To build the mapsforge-routing subproject, copy the attached
   build-joride.xml to the
   (...)/mapsforge/mapsforge-read-only/mapsforge-routing

   and run the ant build

   ant -f build-joride.xml

   Installing Osmosis and mapsforge plugins

   Get and install osmosis from
   http://bretth.dev.openstreetmap.org/osmosis-build/osmosis-latest.tgz, 
  be sure to have osmosis in the path for what follows


== 2.3 Install the mapsforge-routing-hh plugin ==

   Install the mapsforge-routing-hh plugin:

   mkdir ${HOME}/.openstreetmap/osmosis/plugins
   cp <mapsforge-routing>/dist/mapsforge-hh-graph-writer-0.2.4.jar  ${HOME}/.openstreetmap/osmosis/plugins

   I.e: osmosis plugins will be copied to
   ${HOME}/.openstreetmap/osmosis/plugins

   If the mapsforge-maps-writer-plugin is correctly installed, osmosis
   will be able to run the --rgw respectively --routing-graph-writer task.

== 2.5 Create and populate the OSM database ==

   * create database user "osm" with superuse privs (run attached script
   07.createOSMUser as "postgres" user) * create empty database "osm" for
   user osm (run script 08.createDatabaseOSM as "postgres" user) * enable
   PostGIS Extensions for osm database (run script 09.enablePostGISOSM as
   "postgres" user)

   The current revision 2006 of mapsforge comes without an osm2rg schema
   for the OSM database, so we use the one attached in the
   osm2rg.mapsforge.20120415.sql script, which is comes from an older
   mapsforge release but we dropped some not-null-constraints from the
   osm2rg schema to make it finally work.

   * Load modified osmm2rg schema (run attached script 10.populateOSMDB
   which loads the "modified osm2rg schema" osm2rg.mapsforge.20120415.sql)

== 2.6 Creating the HH Graph ==

   Copy the attached config.properties and
   highwayLevel2AverageSpeed.properties files to the mapsforge-routing
   directory. Edit them to Your needs.

   Next, we a finally up to create the HH Graph.

   For what follows, be sure to have psql in the PATH, which can be
   archieved by sourcing /opt/postgres/etc/openride.conf:
 . /opt/postgres/etc/openride.conf

   and make sure the database server is started.

   finally, inside the mapsforge-routing directory, run the
   build-create-hh-graph-joride.xml ant script, which is a modified
   version of the build-create-hh-graph.xml ant script delivered with
   mapsforge.

   The following targets already work:
     * "extract-rg": extracts routing and highway hierarchy data from pbf
       file, and creates a scripts to load them into osm db.
     * "import-rg": runs data extracted by "extract-rg" target into the
       OSM database
     * "produce-onboard-routing-binary": produces a binary of the HH to be
       used by mobile devices. Not needed by jORide
     * "produce-offboard-routing-binary": (!) produces a binary of the HH
       to be used by server side software. Run this to produce the HH for
       jORide.
     * "clean": Clean target

   Not yet working target:
     * "produce-map-binary": Map used by mapsforge android client. Not
       needed by jORide.

= 2.6.1 Obtaining the PBF Files =

   PBF files from Openstreetmap project are obtained from the geofabrik:
   [43] http://www.geofabrik.com .

= 2.6.2.TODOS =

   Make the map target work. Also not needed for openride, it should help
   to understand the map building process.

=== Attachments ===============================================================================

     * build-joride.xml                      "Build script for mapsforge routing subproject" 
     * 07.createOSMUser                      "Create User for OSM DB"
     * 08.createDatabaseOSM                  "create OSM Database"
     * 09.enablePostGISOSM                   "Enable PostGIS for OSM Database"
     * 10.populateOSMDB                      "Load the OSM2RG Schema for OSM Database"
     * osm2rg.mapsforge.20120415.sql         "The OSM2RG schema we currently use"
     * config.properties                     "General Properties for building HH and map files"
     * highwayLevel2AverageSpeed.properties  "Properties file for controlling the Highway Class to Speed mapping."

