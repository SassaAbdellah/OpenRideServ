<project name="joride2" default="build"> 
   <property environment="env"/>
   <property file="build.properties"/> 
   <property file="${app}/tomcat.properties"/> 
   <property name="appdir" value="${basedir}"/>
   <property name="build.dir" value="${appdir}/build"/>
   <property name="web-inf.dir" value="${build.dir}/WEB-INF"/>
   <property name="dist.dir" value="${appdir}/dist"/>
   <!-- warfile which ist the main deliverable of this subproject -->
   <property name="warfile" value="${dist.dir}/${ant.project.name}.war"/>
   <!-- jarfile for use by other subprojects (say: joride-public)-->
   <property name="jarfile" value="${dist.dir}/${ant.project.name}.jar"/>
   
   <path id="classpath">
      <fileset dir="${appdir}">        
        <include name="lib/build/*.jar"/>
      </fileset> 
        <!-- include classes from ejb project -->
        <pathelement location="../OpenRideServer-ejb/dist/OpenRideServer-ejb.jar" />
 
        <!-- external jars from ejb project  -->
      <fileset dir="../OpenRideServer-ejb/libs/">        
	<include name="*.jar"	/>
      </fileset>

      <!-- include jee libs from some glassfish -->

      <fileset dir="../build.headless.support/jee/libs.glassfish.3.0.2/">
	<include name="*.jar"	/>
      </fileset>


   </path>
   

   <target name="prepare" 
         description="Create build and dist directory.">
      <delete dir="${build.dir}"/>
      <mkdir dir="${build.dir}"/>
      <mkdir dir="${web-inf.dir}"/>
      <mkdir dir="${web-inf.dir}/classes"/>
      <mkdir dir="${dist.dir}"/>
   </target>

   <target name="copy" depends="prepare"
         description="Copy files to build directory.">
      <copy todir="${build.dir}" failonerror="false" verbose="true">
         <fileset dir="${appdir}/web"/>
      </copy>
      <copy todir="${web-inf.dir}/classes" 
           failonerror="false" verbose="true">
         <fileset dir="${appdir}/src/java">
            <exclude name="**/*.java"/>
         </fileset>
      </copy>
      <copy todir="${web-inf.dir}" failonerror="false" verbose="true">
         <fileset dir="${appdir}">
            <include name="lib/**"/>
	 </fileset>
      </copy>
   </target>






   <target name="apply-local-properties" depends="copy" description="rewrite properties files with local properties">
 	
           <!-- check, that user has a local.properties file in place in master project -->     
	

        <property file="../local.properties" />

	    <fail message=" ../local.properties file is missing! -- You will probably have to create one, see included local.properties.sample file. ">
            <condition>
                <not>
                        <resourcecount count="1">
                                <fileset id="fs" dir=".." includes="local.properties"/>
                        </resourcecount>
                </not>
           </condition>
        </fail>




        <!-- ****************************  -->
	<!-- Rewrite operational setting   -->
        <!-- ****************************  -->

	<property name="opsparamfile" value="${build.dir}/WEB-INF/classes/de/avci/joride/operational.properties" /> 
        <!-- replace email target -->


        <!-- replaceing mailServiceJNDI property with local settings  -->   
 
       <replaceregexp byline="true">
           <regexp pattern="mailServiceJNDI=(.*)"/>
            <substitution expression="mailServiceJNDI=${mailServiceJNDI}"/>
            <fileset file="${opsparamfile}" />
       </replaceregexp>


     <!-- replaceing   webmasterEmailRecipient property with local settings  -->
        
      <replaceregexp byline="true">
           <regexp pattern="webmasterEmailRecipient=(.*)"/>
            <substitution expression="webmasterEmailRecipient=${webmasterEmailRecipient}"/>
            <fileset file="${opsparamfile}" />
       </replaceregexp>


      <!-- replaceing  businessEmailRecipient  property with local settings  -->
        
      <replaceregexp byline="true">
           <regexp pattern="businessEmailRecipient=(.*)"/>
            <substitution expression="businessEmailRecipient=${businessEmailRecipient}"/>
            <fileset file="${opsparamfile}" />
       </replaceregexp>

      <!-- replaceing  noreplyEmailRecipient  property with local settings  -->

      <replaceregexp byline="true">
           <regexp pattern="noreplyEmailRecipient=(.*)"/>
            <substitution expression="noreplyEmailRecipient=${noreplyEmailRecipient}"/>
            <fileset file="${opsparamfile}" />
       </replaceregexp>




        <!-- ****************************  -->
        <!-- Rewrite navigation settings   -->
        <!-- ****************************  -->

        <property name="navparamfile" value="${build.dir}/WEB-INF/classes/de/avci/joride/navigation.properties" />
       

       <!-- applying url for terms and conditions  -->

      <replaceregexp byline="true">
           <regexp pattern="termsURL=(.*)"/>
            <substitution expression="termsURL=${termsURL}"/>
            <fileset file="${navparamfile}" />
       </replaceregexp>

       <!-- applying url for imprint  -->

      <replaceregexp byline="true">
           <regexp pattern="imprintURL=(.*)"/>
            <substitution expression="imprintURL=${imprintURL}"/>
            <fileset file="${navparamfile}" />
       </replaceregexp>

   </target> <!--  end of target "apply local properties" -->

   
   <target 
	name="compile" 
	depends="copy,apply-local-properties" 
	description="Compile source files."
	>

      <javac 
         srcdir="${appdir}/src/java" 
         destdir="${web-inf.dir}/classes"
         debug="true"
	 includeantruntime="false"
         deprecation="true">
         <compilerarg value="-Xlint:unchecked"/>
         <include name="**/*.java"/>
         <classpath refid="classpath"/>
      </javac>
   </target>
   
   <target name="jsf-libs" if="use-jsf-libs" unless="glassfish">
      <mkdir dir="${web-inf.dir}/lib"/>
      <copy file="${jsf.api.jar}" todir="${web-inf.dir}/lib" verbose="true"/>
      <copy file="${jsf.impl.jar}" todir="${web-inf.dir}/lib" verbose="true"/>
   </target>

   <target name="el-libs" if="use-el-libs" unless="glassfish">
      <copy file="${el.api.jar}" todir="${web-inf.dir}/lib" 
            verbose="true" failonerror="false"/>
      <copy file="${el.impl.jar}" todir="${web-inf.dir}/lib" 
            verbose="true" failonerror="false"/>
   </target>

   <target name="bean-validation-libs" if="use-bean-validation-libs" unless="glassfish">
      <copy file="${bean-validation.impl.jar}" todir="${web-inf.dir}/lib" 
            verbose="true" failonerror="false"/>
      <copy todir="${web-inf.dir}/lib" verbose="true" failonerror="false">
        <fileset dir="${bean-validation.lib.dir}">
           <include name="*.jar"/>
        </fileset>
      </copy>
   </target>

   <target name="cdi-libs" if="use-cdi-libs" unless="glassfish">
      <copy file="${cdi.impl.jar}" todir="${build.dir}/WEB-INF/lib" 
            verbose="true" failonerror="false"/>
   </target>
   
   <target name="tomcat-libs" depends="jsf-libs, el-libs, bean-validation-libs, cdi-libs"/>

   <target name="war" depends="clean, compile, tomcat-libs"
         description="Build WAR file.">
      <delete file="${warfile}"/>
      <jar jarfile="${warfile}" basedir="${build.dir}"/>
   </target>

   <!-- create a jar for use in other subprojects -->
   <target name="jar" depends="clean, compile, tomcat-libs"
         description="Build JAR file for use in other subprojects.">
      <delete file="${jarfile}"/>
      <jar jarfile="${jarfile}" basedir="${web-inf.dir}/classes"/>
   </target>



	
   <target name="build" depends="war,jar" description="build the deliverables (war and jar files)"> 

  </target>

  <target name="dist" depends="build" description="create the distributables, but do not deploy"> 

  </target>




   <target name="install" depends="build"
         description="Deploy web application.">
      <copy file="${warfile}" todir="${deploy.dir}"/>
   </target>

   <target name="clean" 
         description="Clean everything.">
      <delete dir="${build.dir}"/>
      <delete dir="${dist.dir}"/>
   </target>
</project>
